name: Daily NSE Swing Scanner

on:
  schedule:
    - cron: '0 10 * * 0'   # Every Sunday 10:00 UTC = 3:30 PM IST
  workflow_dispatch:
    inputs:
      debug:
        description: 'Run in debug mode'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  scan-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance requests openpyxl

      - name: Run the PRO scanner
        run: python weekly_swing_scanner.py

      - name: Commit & push results
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # Add all potential output files
          git add SWING_PRO_*.csv SWING_PRO_*.xlsx *.csv *.xlsx 2>/dev/null || echo "No files to add"
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto scan results $(date '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "Results pushed successfully"
          fi

      - name: Trigger Streamlit redeploy
        if: success()
        env:
          STREAMLIT_TOKEN: ${{ secrets.STREAMLIT_TOKEN }}
        run: |
          # Only run if STREAMLIT_TOKEN is set
          if [ -n "$STREAMLIT_TOKEN" ]; then
            REPO="AJ-F98/Weekly_SwingTrades_Scanner"
            curl -X POST https://api.streamlit.io/v1/apps/redeploy \
              -H "Authorization: Bearer $STREAMLIT_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"repo\": \"$REPO\", \"branch\": \"main\"}"
          else
            echo "STREAMLIT_TOKEN not set, skipping redeploy trigger"
          fi